name: Deploy Obsidian Vault to Notturno.net

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'
      - '.zola/**'
      - 'Journal/**'
      - 'Id√©es/**'
      - 'Idees/**'
      - 'Projets/**'
      - 'Liens/**'
      - 'Pages/**'
      - 'Assets/**'

  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Vault
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Zola
        uses: taiki-e/install-action@v2
        with:
          tool: zola@0.19.1

      # --- FASE 1: BASH (Spostamento Asset e Pulizia) ---
      - name: üõ†Ô∏è Resource Management & Flattening
        run: |
          echo "--- Gestione Risorse Non-Markdown ---"
          mkdir -p .zola/static/assets
          mkdir -p .zola/content/journal .zola/content/idees .zola/content/projets .zola/content/liens
          
          # Sposta tutti i file NON .md in static/assets (escludendo la cartella .zola stessa)
          find . -type f ! -name "*.md" -not -path "./.zola/*" -not -path "./.git/*" -exec mv {} .zola/static/assets/ \;
          
          # Rimuove le cartelle Assets ora vuote
          find . -type d -name "Assets" -exec rm -rf {} + 2>/dev/null || true

          echo "--- Flattening Post ---"
          # Spostiamo i file mantenendo traccia del path per Python (temporaneamente)
          # Usiamo cp e poi rm per evitare errori di find durante lo spostamento
          cp -r Journal/* .zola/content/journal/ 2>/dev/null || true
          cp -r Id√©es/* .zola/content/idees/ 2>/dev/null || true
          cp -r Idees/* .zola/content/idees/ 2>/dev/null || true
          cp -r Projets/* .zola/content/projets/ 2>/dev/null || true
          cp -r Liens/* .zola/content/liens/ 2>/dev/null || true

          # Pulizia root dalle cartelle originali (ormai processate)
          rm -rf Journal Id√©es Idees Projets Liens Pages Assets

      # --- FASE 2: PYTHON (Data da Path, Slug e Fix Link) ---
      - name: üß† Logic Injection (Path to Date & Index Generation)
        shell: python
        run: |
          import os, re, unicodedata
          from datetime import datetime

          content_dir = ".zola/content"
          path_date_re = re.compile(r'(\d{4})[\\/](\d{2})')
          obs_img = re.compile(r'!\[\[(.*?)(?:\|(.*?))?\]\]')

          def slugify(t):
              t = unicodedata.normalize('NFKD', t).encode('ascii', 'ignore').decode('utf-8')
              return re.sub(r'[-\s]+', '-', re.sub(r'[^\w\s-]', '', t).strip().lower())

          # 1. GENERAZIONE INDICI (_index.md)
          # Root Index
          with open(os.path.join(content_dir, "_index.md"), "w") as f:
              f.write('+++\ntitle = "Home"\nsort_by = "date"\npaginate_by = 10\nrender = true\n+++\n')

          sections = ["journal", "idees", "projets", "liens"]
          for s in sections:
              s_path = os.path.join(content_dir, s)
              if os.path.exists(s_path):
                  for root, dirs, _ in os.walk(s_path):
                      is_root_section = (root == s_path)
                      with open(os.path.join(root, "_index.md"), "w") as f:
                          if is_root_section:
                              f.write(f'+++\ntitle = "{s.title()}"\nsort_by = "date"\ntransparent = true\nrender = true\n+++\n')
                          else:
                              f.write('+++\ntransparent = true\n+++\n')

          # 2. PROCESSO POST ESISTENTI
          for root, dirs, files in os.walk(content_dir):
              for fn in files:
                  if not fn.endswith(".md") or fn.startswith("_index"): continue
                  fp = os.path.join(root, fn)
                  
                  date_match = path_date_re.search(fp)
                  extracted_date = f"{date_match.group(1)}-{date_match.group(2)}-01" if date_match else datetime.utcnow().strftime('%Y-%m-%d')

                  with open(fp, 'r', encoding='utf-8') as f: lines = f.readlines()
                  
                  raw_title = fn.replace(".md", "").replace("-", " ")
                  fm = [
                      "+++\n",
                      f"title = \"{raw_title.title()}\"\n",
                      f"date = {extracted_date}\n",
                      f"slug = \"{slugify(raw_title)}\"\n",
                      "template = \"page.html\"\n",
                      "+++\n\n"
                  ]
                  
                  def repl(ma):
                      img_fn = os.path.basename(ma.group(1).strip()).replace(" ", "%20")
                      return f'![image](/assets/{img_fn})'

                  body = "".join(lines)
                  body = re.sub(r'^#\s+.*\n?', '', body, flags=re.MULTILINE)
                  new_content = "".join(fm) + obs_img.sub(repl, body)

                  with open(fp, 'w', encoding='utf-8') as f: f.write(new_content)

      # --- FASE 3: BUILD ---
      - name: üèóÔ∏è Build Zola
        run: |
          cd .zola && zola build --base-url https://notturno.net

      - name: üöÄ Deploy
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: '.zola/public'
          destination-github-username: 'matteokutufa'
          destination-repository-name: 'notturno.net'
          user-email: 'mk@bytehawks.org'
          target-branch: main

