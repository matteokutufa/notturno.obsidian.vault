name: Deploy Obsidian Vault to Notturno.net

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'
      - '.zola/**'
      - 'Journal/**'
      - 'IdÃ©es/**'
      - 'Idees/**'
      - 'Projets/**'
      - 'Liens/**'
      - 'Pages/**'
      - 'Assets/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Vault
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Zola
        uses: taiki-e/install-action@v2
        with:
          tool: zola@0.19.1

      # --- FASE 1: BASH (Spostamento Asset e Pulizia) ---
      - name: ðŸ› ï¸ Resource Management & Flattening
        run: |
          echo "--- Gestione Risorse Non-Markdown ---"
          mkdir -p .zola/static/assets
          mkdir -p .zola/content/journal .zola/content/idees .zola/content/projets .zola/content/liens
          
          # Sposta tutti i file NON .md in static/assets (escludendo la cartella .zola stessa)
          find . -type f ! -name "*.md" -not -path "./.zola/*" -not -path "./.git/*" -exec mv {} .zola/static/assets/ \;
          
          # Rimuove le cartelle Assets ora vuote
          find . -type d -name "Assets" -exec rm -rf {} + 2>/dev/null || true

          echo "--- Flattening Post ---"
          # Spostiamo i file mantenendo traccia del path per Python (temporaneamente)
          # Usiamo cp e poi rm per evitare errori di find durante lo spostamento
          cp -r Journal/* .zola/content/journal/ 2>/dev/null || true
          cp -r IdÃ©es/* .zola/content/idees/ 2>/dev/null || true
          cp -r Idees/* .zola/content/idees/ 2>/dev/null || true
          cp -r Projets/* .zola/content/projets/ 2>/dev/null || true
          cp -r Liens/* .zola/content/liens/ 2>/dev/null || true

          # Pulizia root dalle cartelle originali (ormai processate)
          rm -rf Journal IdÃ©es Idees Projets Liens Pages Assets

      # --- FASE 2: PYTHON (Data da Path, Slug e Fix Link) ---
      - name: ðŸ§  Logic Injection (Path to Date)
        shell: python
        run: |
          import os, re, unicodedata
          from datetime import datetime

          content_dir = ".zola/content"
          # Regex per estrarre AAAA/MM dal percorso
          path_date_re = re.compile(r'(\d{4})[\\/](\d{2})')
          obs_img = re.compile(r'!\[\[(.*?)(?:\|(.*?))?\]\]')

          def slugify(t):
              t = unicodedata.normalize('NFKD', t).encode('ascii', 'ignore').decode('utf-8')
              return re.sub(r'[-\s]+', '-', re.sub(r'[^\w\s-]', '', t).strip().lower())

          for root, dirs, files in os.walk(content_dir):
              for fn in files:
                  if not fn.endswith(".md") or fn.startswith("_index"): continue
                  fp = os.path.join(root, fn)
                  
                  # 1. Recupero data dal percorso AAAA/MM
                  date_match = path_date_re.search(fp)
                  if date_match:
                      # Se trovato nel path, impostiamo come YYYY-MM-01 (giorno fittizio se manca)
                      extracted_date = f"{date_match.group(1)}-{date_match.group(2)}-01"
                  else:
                      extracted_date = datetime.utcnow().strftime('%Y-%m-%d')

                  with open(fp, 'r', encoding='utf-8') as f: lines = f.readlines()
                  
                  # Generazione Titolo e Slug
                  raw_title = fn.replace(".md", "").replace("-", " ")
                  
                  # Front Matter
                  fm = [
                      "+++\n",
                      f"title = \"{raw_title.title()}\"\n",
                      f"date = {extracted_date}\n",
                      f"slug = \"{slugify(raw_title)}\"\n",
                      "template = \"page.html\"\n",
                      "+++\n\n"
                  ]
                  
                  # 2. Fix link immagini (tutte in /assets/)
                  def repl(ma):
                      img_fn = os.path.basename(ma.group(1).strip()).replace(" ", "%20")
                      return f'![image](/assets/{img_fn})'

                  body = "".join(lines)
                  # Rimuove H1 se duplicato
                  body = re.sub(r'^#\s+.*\n?', '', body, flags=re.MULTILINE)
                  new_content = "".join(fm) + obs_img.sub(repl, body)

                  with open(fp, 'w', encoding='utf-8') as f: f.write(new_content)

      # --- FASE 3: BUILD ---
      - name: ðŸ—ï¸ Build Zola
        run: |
          # Creazione index root per abilitare il sorting in home
          for s in journal idees projets liens; do
             echo -e "+++\ntitle = \"$s\"\nsort_by = \"date\"\ntransparent = true\n+++" > .zola/content/$s/_index.md
          done
          cd .zola && zola build --base-url https://notturno.net

      - name: ðŸš€ Deploy
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: '.zola/public'
          destination-github-username: 'matteokutufa'
          destination-repository-name: 'notturno.net'
          user-email: 'mk@bytehawks.org'
          target-branch: main

