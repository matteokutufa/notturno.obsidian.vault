name: Deploy Obsidian Vault to Notturno.net

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'
      - '.zola/**'
      - 'content/**'
      - 'static/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Vault
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Zola
        run: |
          curl -L -o zola.tar.gz https://github.com/getzola/zola/releases/download/v0.22.1/zola-v0.22.1-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf zola.tar.gz -C /tmp zola
          chmod +x /tmp/zola
          rm zola.tar.gz

      
      # --- FASE 1: BASH (Spostamento Asset e Pulizia) ---
      - name: ğŸ› ï¸ Resource Management & Flattening
        run: |
          # Moving all resources into .zola folder
          mv -v ./content .zola/ 2>/dev/null || true
          mv -v ./static .zola/ 2>/dev/null || true

          # Cleanup unnecessary files and folders
          rm -vfr .obsidian

      # --- FASE 2: PYTHON (Data da Path, Slug e Fix Link) ---
      - name: ğŸ§  Logic Injection (Path to Date & Index Generation)
        shell: python
        run: |
          import os, re, unicodedata
          from datetime import datetime

          content_dir = ".zola/content"
          path_date_re = re.compile(r'(\d{4})[\\/](\d{2})')
          obs_img = re.compile(r'!\[\[(.*?)(?:\|(.*?))?\]\]')

          def slugify(t):
              t = unicodedata.normalize('NFKD', t).encode('ascii', 'ignore').decode('utf-8')
              return re.sub(r'[-\s]+', '-', re.sub(r'[^\w\s-]', '', t).strip().lower())

          # 1. GENERAZIONE INDICI (_index.md)
          # Root Index
          with open(os.path.join(content_dir, "_index.md"), "w") as f:
              f.write('+++\ntitle = "Home"\nsort_by = "date"\npaginate_by = 10\nrender = true\n+++\n')

          sections = ["journal", "idees", "projets", "liens"]
          for s in sections:
              s_path = os.path.join(content_dir, s)
              if os.path.exists(s_path):
                  for root, dirs, _ in os.walk(s_path):
                      is_root_section = (root == s_path)
                      with open(os.path.join(root, "_index.md"), "w") as f:
                          if is_root_section:
                              f.write(f'+++\ntitle = "{s.title()}"\nsort_by = "date"\ntransparent = true\nrender = true\n+++\n')
                          else:
                              f.write('+++\ntransparent = true\n+++\n')

# --- FASE 2: PYTHON (Data da Nome File, Slug e Front Matter) ---
      - name: ğŸ§  Logic Injection (Title, Date & Slug from Filename)
        shell: python
        run: |
          import os, re, unicodedata
          from datetime import datetime

          content_dir = ".zola/content"
          # Pattern per catturare: Titolo (YYYYMMDD).md
          file_pattern = re.compile(r"^(.*)\s\((\d{8})\)$")
          obs_img = re.compile(r'!\[\[(.*?)(?:\|(.*?))?\]\]')

          def slugify(t):
              t = unicodedata.normalize('NFKD', t).encode('ascii', 'ignore').decode('utf-8')
              return re.sub(r'[-\s]+', '-', re.sub(r'[^\w\s-]', '', t).strip().lower())

          # 1. GENERAZIONE INDICI (_index.md) - Solo per cartelle principali
          sections = ["journal", "idees", "projets", "liens"]
          for s in sections:
              s_path = os.path.join(content_dir, s)
              if os.path.exists(s_path):
                  idx_path = os.path.join(s_path, "_index.md")
                  if not os.path.exists(idx_path):
                      with open(idx_path, "w") as f:
                          f.write(f'+++\ntitle = "{s.title()}"\nsort_by = "date"\ntransparent = true\nrender = true\n+++\n')

          # 2. PROCESSO POST CON PATTERN "TITOLO (DATA)"
          for root, _, files in os.walk(content_dir):
              for fn in files:
                  if not fn.endswith(".md") or fn.startswith("_index"): continue
                  
                  name_no_ext = os.path.splitext(fn)[0]
                  match = file_pattern.match(name_no_ext)
                  
                  # Se il file non ha la data nel nome (es. Contact.md), lo saltiamo
                  if not match:
                      continue

                  raw_title = match.group(1).strip()
                  raw_date = match.group(2) # YYYYMMDD
                  
                  # Formattazione data per Zola: YYYY-MM-DD
                  formatted_date = f"{raw_date[:4]}-{raw_date[4:6]}-{raw_date[6:8]}"
                  slug = slugify(raw_title)
                  
                  fp = os.path.join(root, fn)
                  with open(fp, 'r', encoding='utf-8') as f: body_content = f.read()

                  # Pulizia eventuale titolo H1 duplicato nel body
                  body_content = re.sub(r'^#\s+.*\n?', '', body_content, flags=re.MULTILINE)

                  # Estrazione featured image (Markdown o Obsidian style)
                  first_img_match = obs_img.search(body_content)
                  featured_img = ""
                  if first_img_match:
                      img_name = os.path.basename(first_img_match.group(1).strip()).replace(" ", "%20")
                      featured_img = f"/static/{img_name}"

                  # Costruzione Front Matter
                  fm = [
                      "+++\n",
                      f"title = \"{raw_title}\"\n",
                      f"date = {formatted_date}\n",
                      f"slug = \"{slug}\"\n"
                  ]
                  if featured_img:
                      fm.append(f"extra.image = \"{featured_img}\"\n")
                  fm.append("+++\n\n")

                  # Fix link immagini Obsidian -> Standard Markdown
                  def repl(ma):
                      img_fn = os.path.basename(ma.group(1).strip()).replace(" ", "%20")
                      return f'![image](/static/{img_fn})'

                  new_content = "".join(fm) + obs_img.sub(repl, body_content)

                  with open(fp, 'w', encoding='utf-8') as f: f.write(new_content)

      # --- FASE 3: BUILD ---
      - name: ğŸ—ï¸ Build Zola
        run: |
          cd .zola && /tmp/zola build --base-url https://notturno.net

      - name: ğŸš€ Deploy
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: '.zola/public'
          destination-github-username: 'matteokutufa'
          destination-repository-name: 'notturno.net'
          user-email: 'mk@bytehawks.org'
          target-branch: main

