name: Deploy Obsidian Vault to Notturno.net

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'
      - '.zola/**'
      - 'content/**'
      - 'static/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Vault
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Zola
        run: |
          curl -L -o zola.tar.gz https://github.com/getzola/zola/releases/download/v0.22.1/zola-v0.22.1-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf zola.tar.gz -C /tmp zola
          chmod +x /tmp/zola
          rm zola.tar.gz

      
# --- FASE 1: BASH (Spostamento Asset e Setup Struttura Zola) ---
      - name: üõ†Ô∏è Resource Management
        run: |
          # Prepariamo la struttura Zola
          mkdir -p .zola/static
          
          # Spostiamo il contenuto
          mv -v ./content .zola/ 2>/dev/null || true
          
          # Spostiamo assets dentro static affinch√© Zola lo mappi su /assets/
          mv -v ./assets .zola/static/ 2>/dev/null || true

          # Cleanup
          rm -vfr .obsidian

      # --- FASE 2: PYTHON (Logic Injection & Asset Fix) ---
      - name: üß† Logic Injection (Title, Date & Slug from Filename)
        shell: python
        run: |
          import os, re, unicodedata

          content_dir = ".zola/content"
          file_pattern = re.compile(r"^(.*)\s\((\d{8})\)$")
          obs_img = re.compile(r'!\[\[(.*?)(?:\|(.*?))?\]\]')

          def slugify(t):
              t = unicodedata.normalize('NFKD', t).encode('ascii', 'ignore').decode('utf-8')
              return re.sub(r'[-\s]+', '-', re.sub(r'[^\w\s-]', '', t).strip().lower())

          # 1. GENERAZIONE INDICI (Solo se mancanti nelle sezioni principali)
          sections = ["journal", "idees", "projets", "liens"]
          for s in sections:
              s_path = os.path.join(content_dir, s)
              if os.path.exists(s_path):
                  idx_path = os.path.join(s_path, "_index.md")
                  if not os.path.exists(idx_path):
                      with open(idx_path, "w") as f:
                          f.write(f'+++\ntitle = "{s.title()}"\nsort_by = "date"\ntransparent = true\nrender = true\n+++\n')

          # 2. PROCESSO POST CON FILTRO SU NOME FILE
          for root, _, files in os.walk(content_dir):
              for fn in files:
                  if not fn.endswith(".md") or fn.startswith("_index"): continue
                  
                  name_no_ext = os.path.splitext(fn)[0]
                  match = file_pattern.match(name_no_ext)
                  
                  # SALTO i file che non seguono il pattern "Titolo (YYYYMMDD)"
                  if not match:
                      continue

                  raw_title = match.group(1).strip()
                  raw_date = match.group(2)
                  formatted_date = f"{raw_date[:4]}-{raw_date[4:6]}-{raw_date[6:8]}"
                  slug = slugify(raw_title)
                  
                  fp = os.path.join(root, fn)
                  with open(fp, 'r', encoding='utf-8') as f: body_content = f.read()

                  # Pulizia eventuale H1 residuo nel corpo
                  body_content = re.sub(r'^#\s+.*\n?', '', body_content, flags=re.MULTILINE)

                  # Regex per trasformare link Obsidian in Markdown standard puntando a /assets/
                  def repl(ma):
                      img_fn = os.path.basename(ma.group(1).strip()).replace(" ", "%20")
                      return f'![image](/assets/{img_fn})'

                  # Estrazione featured image per il Front Matter
                  first_img_match = obs_img.search(body_content)
                  featured_img = ""
                  if first_img_match:
                      img_name = os.path.basename(first_img_match.group(1).strip()).replace(" ", "%20")
                      featured_img = f"/assets/{img_name}"

                  # Ricostruzione file con Front Matter Zola
                  fm = [
                      "+++\n",
                      f"title = \"{raw_title}\"\n",
                      f"date = {formatted_date}\n",
                      f"slug = \"{slug}\"\n",
                      "template = \"page.html\"\n"
                  ]
                  if featured_img:
                      fm.append(f"extra.image = \"{featured_img}\"\n")
                  fm.append("+++\n\n")

                  new_content = "".join(fm) + obs_img.sub(repl, body_content)

                  with open(fp, 'w', encoding='utf-8') as f: f.write(new_content)
      # --- FASE 3: BUILD ---
      - name: üèóÔ∏è Build Zola
        run: |
          cd .zola && /tmp/zola build --base-url https://notturno.net

      - name: üöÄ Deploy
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: '.zola/public'
          destination-github-username: 'matteokutufa'
          destination-repository-name: 'notturno.net'
          user-email: 'mk@bytehawks.org'
          target-branch: main

