name: Deploy Obsidian Vault to Notturno.net

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy.yml'
      - '.github/workflows/deploy.yaml'
      - '.zola/**'
      - 'Journal/**'
      - 'Id√©es/**'
      - 'Idees/**'
      - 'Projets/**'
      - 'Liens/**'
      - 'Pages/**'
      - 'Assets/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Vault
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Zola
        uses: taiki-e/install-action@v2
        with:
          tool: zola@0.19.1

      - name: üõ†Ô∏è Transform Vault to Zola Structure
        run: |
          # 1. Pulizia e Setup
          mkdir -p .zola/content/journal .zola/content/idees .zola/content/projets .zola/content/liens
          mkdir -p .zola/static/assets # Cartella dedicata per evitare 404
          
          # 2. Copia Contenuti
          cp -r Journal/* .zola/content/journal/ 2>/dev/null || true
          if [ -d "Id√©es" ]; then cp -r Id√©es/* .zola/content/idees/; fi
          if [ -d "Idees" ]; then cp -r Idees/* .zola/content/idees/; fi
          cp -r Projets/* .zola/content/projets/ 2>/dev/null || true
          cp -r Liens/* .zola/content/liens/ 2>/dev/null || true
          
          # 3. Pagine Singole e CNAME
          if [ -d "Pages" ]; then cp Pages/*.md .zola/content/; fi
          echo "notturno.net" > .zola/static/CNAME
          
          # 4. Assets Centralizzati in /assets/
          find . -type d -name "Assets" -not -path "./.zola/*" -exec cp -r {}/* .zola/static/assets/ \; 2>/dev/null || true

          # 5. Generazione Index Ricorsiva
          find .zola/content -type d -not -path ".zola/content" | while read -r dir; do
            if [ ! -f "$dir/_index.md" ]; then
              SECTION_NAME=$(basename "$dir")
              IS_ROOT=false
              for r in journal idees projets liens; do
                if [[ "$dir" == ".zola/content/$r" ]]; then IS_ROOT=true; fi
              done

              if [ "$IS_ROOT" = true ]; then
                TITLE=$(echo "$SECTION_NAME" | sed 's/./\U&/')
                if [ "$SECTION_NAME" == "idees" ]; then TITLE="Id√©es"; fi
                echo -e "+++\ntitle = \"$TITLE\"\nsort_by = \"date\"\ntemplate = \"section.html\"\n+++" > "$dir/_index.md"
              else
                echo -e "+++\ntitle = \"$SECTION_NAME\"\nsort_by = \"date\"\ntemplate = \"section.html\"\ntransparent = true\n+++" > "$dir/_index.md"
              fi
            fi
          done

      - name: üß† Auto-Inject Metadata & Fix Links
        shell: python
        run: |
          import os, re, unicodedata
          from datetime import datetime

          content_dir = ".zola/content"
          obs_img = re.compile(r'!\[\[(.*?)(?:\|(.*?))?\]\]')

          def slugify(t):
              t = unicodedata.normalize('NFKD', t).encode('ascii', 'ignore').decode('utf-8')
              return re.sub(r'[-\s]+', '-', re.sub(r'[^\w\s-]', '', t).strip().lower())

          for root, dirs, files in os.walk(content_dir):
              for fn in files:
                  if not fn.endswith(".md") or fn.startswith("_index"): continue
                  fp = os.path.join(root, fn)
                  with open(fp, 'r', encoding='utf-8') as f: lines = f.readlines()
                  
                  if not (len(lines) > 0 and lines[0].strip() == '+++'):
                      raw = fn.replace(".md", "")
                      m = re.match(r'^(\d{4}-\d{2}-\d{2})-(.*)', raw)
                      d_str = m.group(1) if m else datetime.utcnow().strftime('%Y-%m-%d')
                      t_raw = m.group(2).replace("-", " ") if m else raw.replace("-", " ")
                      
                      # Fallback data da folder
                      if not m:
                          pts = fp.split(os.sep)
                          y = next((p for p in pts if re.match(r'^\d{4}$', p)), None)
                          mo = next((p for p in pts if re.match(r'^\d{2}$', p) and 1<=int(p)<=12), "01")
                          if y: d_str = f"{y}-{mo}-01"

                      fm = [f"+++\ntitle = \"{t_raw.title()}\"\ndate = {d_str}\nslug = \"{slugify(t_raw)}\"\ntemplate = \"page.html\"\n+++\n\n"]
                      body = lines[1:] if len(lines) > 0 and lines[0].startswith("# ") else lines
                      c_str = "".join(fm + body)
                  else:
                      c_str = "".join(lines)

                  # FIX IMMAGINI: Tutti i link puntano a /assets/
                  def repl(ma):
                      p = os.path.basename(ma.group(1).strip())
                      a = ma.group(2).strip() if ma.group(2) else ""
                      return f'![{a}](/assets/{p})'

                  with open(fp, 'w', encoding='utf-8') as f:
                      f.write(obs_img.sub(repl, c_str))

      - name: üèóÔ∏è Build Site
        working-directory: .zola
        run: zola build --base-url https://notturno.net

      - name: üöÄ Deploy
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source-directory: '.zola/public'
          destination-github-username: 'matteokutufa'
          destination-repository-name: 'notturno.net'
          user-email: 'mk@bytehawks.org'
          target-branch: main
          commit-message: "Deploy: ${{ github.event.head_commit.message }}"